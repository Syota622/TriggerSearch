# TriggerSearch（trigs）設計書（更新版）

## 1. アプリ概要

| 項目 | 内容 |
|------|------|
| アプリ名 | TriggerSearch |
| 略称 | trigs |
| 目的 | 「頭痛」「アレルギー」などの症状の原因（トリガー）を発見する |
| 設計方針 | お年寄りでも使える超シンプルなUI、複雑性は一切排除 |

---

## 2. 機能一覧

### 2.1 毎日の記録（入力）

| 機能 | 説明 |
|------|------|
| 症状記録 | 「頭痛」「アレルギー」が起きたか（あり/なし） |
| 食事記録 | 食べたものをアイコンで選択（複数選択可） |
| 睡眠記録 | 何時間寝たか（スライダーで選択） |
| 天気記録 | 晴れ/曇り/雨/雪（アイコンで選択） |

### 2.2 分析（自動）

| 機能 | 説明 |
|------|------|
| トリガー分析 | 蓄積データから症状の原因を自動推測 |
| 結果表示 | 「〇〇を食べた日は頭痛が多い」などシンプルに表示 |
| データ不足表示 | 7日未満の場合「もう少し記録がたまると原因がわかります」と表示 |

### 2.3 通知（リマインダー）

| 機能 | 説明 |
|------|------|
| 夜の通知 | 設定した時間に「今日の調子はどうでしたか？」と通知 |
| 時間設定 | 20:00 / 21:00 / 22:00 から選択 |
| ON/OFF | ユーザーが自由に切り替え可能 |

---

## 3. データベース設計

### 3.1 テーブル一覧

```
users              - ユーザー情報
daily_records      - 毎日の記録（メイン）
record_foods       - 記録と食品の中間テーブル
foods              - 食品マスタ
weather_types      - 天気マスタ
symptoms           - 症状マスタ
user_settings      - ユーザー設定（通知など）
```

### 3.2 テーブル詳細

#### users（ユーザー）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| name | VARCHAR(100) | ユーザー名 |
| email | VARCHAR(255) | メールアドレス |
| created_at | TIMESTAMP | 登録日時 |

#### daily_records（毎日の記録）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| user_id | INT | ユーザーID（外部キー） |
| record_date | DATE | 記録日 |
| has_headache | BOOLEAN | 頭痛あり？ |
| has_allergy | BOOLEAN | アレルギーあり？ |
| sleep_hours | DECIMAL(3,1) | 睡眠時間（例: 7.5） |
| weather_id | INT | 天気ID（外部キー） |
| memo | TEXT | メモ（任意） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### record_foods（記録と食品の中間テーブル）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| record_id | INT | 記録ID（外部キー） |
| food_id | INT | 食品ID（外部キー） |

#### foods（食品マスタ）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| name | VARCHAR(100) | 食品名 |
| icon | VARCHAR(10) | 絵文字アイコン |
| category | VARCHAR(50) | カテゴリ |

```
初期データ:
1: パン・小麦, 🍞, 穀物
2: 乳製品, 🥛, 乳製品
3: 卵, 🥚, 卵
4: 肉, 🍖, 肉類
5: 魚, 🐟, 魚介類
6: ごはん, 🍚, 穀物
7: 麺類, 🍜, 穀物
8: 野菜, 🥬, 野菜
9: 果物, 🍎, 果物
10: お菓子, 🍰, 菓子
11: コーヒー, ☕, 飲料
12: お酒, 🍺, 飲料
```

#### weather_types（天気マスタ）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| name | VARCHAR(20) | 天気名 |
| icon | VARCHAR(10) | 絵文字アイコン |

```
初期データ:
1: 晴れ, ☀️
2: 曇り, ☁️
3: 雨, 🌧️
4: 雪, ❄️
```

#### symptoms（症状マスタ）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| name | VARCHAR(50) | 症状名 |
| icon | VARCHAR(10) | 絵文字アイコン |

```
初期データ:
1: 頭痛, 🤕
2: アレルギー, 🤧
```

#### user_settings（ユーザー設定）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INT | 主キー |
| user_id | INT | ユーザーID（外部キー） |
| notify_enabled | BOOLEAN | 通知ON/OFF |
| notify_time | TIME | 通知時間（例: 21:00） |
| updated_at | TIMESTAMP | 更新日時 |

---

## 4. REST API設計

### 4.1 エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/users | ユーザー登録 |
| GET | /api/users/{id} | ユーザー情報取得 |
| POST | /api/records | 毎日の記録を登録 |
| GET | /api/records/{user_id} | 記録一覧取得 |
| GET | /api/records/{user_id}/{date} | 特定日の記録取得 |
| PUT | /api/records/{id} | 記録を更新 |
| GET | /api/analysis/{user_id} | トリガー分析結果取得 |
| GET | /api/weather | 天気一覧取得 |
| GET | /api/foods | 食品一覧取得 |
| GET | /api/settings/{user_id} | ユーザー設定取得 |
| PUT | /api/settings/{user_id} | ユーザー設定更新 |

### 4.2 API詳細

#### POST /api/records（毎日の記録を登録）

**リクエスト**
```json
{
  "user_id": 1,
  "record_date": "2025-01-15",
  "has_headache": true,
  "has_allergy": false,
  "sleep_hours": 6.5,
  "weather_id": 3,
  "food_ids": [1, 2, 7],
  "memo": ""
}
```

**レスポンス（成功）**
```json
{
  "status": "success",
  "data": {
    "id": 123,
    "record_date": "2025-01-15",
    "message": "記録しました"
  }
}
```

#### GET /api/analysis/{user_id}（トリガー分析）

**レスポンス（データ十分な場合）**
```json
{
  "status": "success",
  "data": {
    "user_id": 1,
    "analyzed_at": "2025-01-15T10:00:00Z",
    "total_records": 30,
    "has_enough_data": true,
    "triggers": [
      {
        "symptom": "頭痛",
        "trigger": "睡眠不足",
        "icon": "😴",
        "message": "6時間未満の日は頭痛になりやすい"
      },
      {
        "symptom": "頭痛",
        "trigger": "雨の日",
        "icon": "🌧️",
        "message": "雨の日は頭痛になりやすい"
      },
      {
        "symptom": "アレルギー",
        "trigger": "乳製品",
        "icon": "🥛",
        "message": "乳製品を食べた日はアレルギーが出やすい"
      }
    ]
  }
}
```

**レスポンス（データ不足の場合）**
```json
{
  "status": "success",
  "data": {
    "user_id": 1,
    "total_records": 5,
    "has_enough_data": false,
    "required_records": 7,
    "remaining_records": 2,
    "message": "もう少し記録がたまると原因がわかります"
  }
}
```

#### PUT /api/settings/{user_id}（ユーザー設定更新）

**リクエスト**
```json
{
  "notify_enabled": true,
  "notify_time": "21:00"
}
```

**レスポンス（成功）**
```json
{
  "status": "success",
  "data": {
    "notify_enabled": true,
    "notify_time": "21:00",
    "message": "設定を保存しました"
  }
}
```

---

## 5. 画面設計

### 5.1 画面一覧（4画面）

| 画面名 | 説明 |
|--------|------|
| ホーム画面 | 記録ボタン + 分析ボタン + 設定ボタン |
| 記録画面 | 症状・食事・睡眠・天気を入力 |
| 結果画面 | トリガー分析結果 or データ不足メッセージ |
| 設定画面 | 通知ON/OFF・通知時間の設定 |

### 5.2 画面フロー

```
[ホーム画面]
    │
    ├── [記録する] → 記録画面 → 保存 → ホームに戻る
    │
    ├── [原因を見る] → 結果画面 → ホームに戻る
    │
    └── [設定] → 設定画面 → ホームに戻る
```

### 5.3 UI設計方針

| 方針 | 理由 |
|------|------|
| ボタンは大きく | お年寄りでも押しやすい |
| 文字は大きく | 読みやすさ重視 |
| 色は意味を持たせる | オレンジ=行動、緑=結果、赤=あり、青=なし |
| 入力は選択式 | キーボード入力を最小限に |
| 食事はアイコン選択 | タップだけで複数選択可能 |
| 1画面1目的 | 迷わない設計 |

---

## 6. トリガー分析ロジック

### 6.1 分析の仕組み

```
1. 過去30日分のデータを取得
2. 症状が「あり」の日と「なし」の日を分類
3. 各要素（食事・睡眠・天気）との相関を計算
4. 相関が高い順に「トリガー候補」として表示
```

### 6.2 相関計算の例

```
【頭痛と睡眠時間の相関】

頭痛あり（10日間）の平均睡眠: 5.2時間
頭痛なし（20日間）の平均睡眠: 7.8時間

→ 差が大きい = 睡眠不足がトリガーの可能性が高い

【アレルギーと乳製品の相関】

アレルギーあり（8日間）のうち乳製品を食べた日: 7日（87.5%）
アレルギーなし（22日間）のうち乳製品を食べた日: 5日（22.7%）

→ 差が大きい = 乳製品がトリガーの可能性が高い
```

### 6.3 分析に必要な最低データ数

| 条件 | 理由 |
|------|------|
| 最低7日分 | 1週間の傾向を見るため |
| 推奨30日分 | より正確な分析のため |

### 6.4 データ不足時の表示

```
📊
もう少し記録がたまると
原因がわかります

現在 5日分の記録
あと 2日分で分析できます
```

---

## 7. 通知機能

### 7.1 通知の仕様

| 項目 | 内容 |
|------|------|
| 通知メッセージ | 「今日の調子はどうでしたか？」 |
| 通知時間 | 20:00 / 21:00 / 22:00 から選択 |
| デフォルト | ON（21:00） |
| 変更 | 設定画面でいつでもON/OFF可能 |

### 7.2 通知のトーン

- プレッシャーを与えない
- やさしい問いかけ
- 「毎日続けましょう」などの強制感のある表現は使わない

---

## 8. 技術スタック（推奨）

| レイヤー | 技術 |
|---------|------|
| フロントエンド | React Native または Flutter |
| バックエンド | Node.js + Express または Python + FastAPI |
| データベース | PostgreSQL または SQLite（軽量版） |
| プッシュ通知 | Firebase Cloud Messaging |
| ホスティング | Vercel, Railway, または AWS |

---

## 9. 今後の拡張案（将来）

| 機能 | 説明 |
|------|------|
| 天気自動取得 | 位置情報から天気を自動入力 |
| 症状の追加 | 頭痛・アレルギー以外も追加可能に |
| AIによる分析強化 | より高度なパターン認識 |
| 医師への共有機能 | 記録データをPDFで出力 |

---

## 10. 開発フェーズ

| フェーズ | 内容 | 期間目安 |
|---------|------|---------|
| Phase 1 | DB設計・API基本実装 | 1週間 |
| Phase 2 | 記録機能（入力画面） | 1週間 |
| Phase 3 | 分析機能・通知機能 | 1週間 |
| Phase 4 | UI調整・テスト | 1週間 |

---
